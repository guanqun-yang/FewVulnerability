import re
import os
import itertools
import subprocess

import numpy as np

from utils.common import remove_directories, get_current_time

os.environ["CUDA_VISIBLE_DEVICES"] = str(0)
os.environ['MKL_SERVICE_FORCE_INTEL'] = str(1)

time = get_current_time()
categories = ['bypass', 'csrf', 'dirtra', 'dos', 'execution', 
              'fileinc', 'gainpre', 'httprs', 'infor', 'overflow', 
              'sqli', 'xss']


remove_directories(["hpo"])
for memc_prop, category, size, info_frac in itertools.product([0.10],
                                                              categories,
                                                              [64],
                                                              [None]):
    for crf, n_shot, n_neighbor in itertools.product([True],
                                                     [None],
                                                     [1]):
        for run in range(1, 11):
            os.environ["RUN"] = str(run)
            os.environ["CATEGORY"] = category
            os.environ["SIZE"] = str(size)
            os.environ["INFO_FRAC"] = str(info_frac)
            os.environ["CRF"] = str(crf)
            os.environ["N_SHOT"] = str(n_shot)
            os.environ["N_NEIGHBOR"] = str(n_neighbor)
            os.environ["TIME"] = str(time)

            command = "python tl_single.py"
            subprocess.run(re.split(r"\s+", command))
    
    remove_directories(["hpo"])
    
